<!doctype html>
<html lang="pt">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Análise de Comentários de Pacientes</title>

        <!-- TensorFlow.js и Universal Sentence Encoder -->
        <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/universal-sentence-encoder@1.3.3"></script>

        <style>
            body {
                font-family: Arial, sans-serif;
                padding: 24px;
                max-width: 800px;
                margin: auto;
            }
            textarea {
                width: 100%;
                height: 150px;
                padding: 12px;
                font-size: 16px;
                border-radius: 12px;
                border: 1px solid #ccc;
            }
            button {
                margin-top: 20px;
                padding: 14px;
                font-size: 18px;
                width: 100%;
                background: #007bff;
                color: white;
                border: none;
                border-radius: 12px;
                cursor: pointer;
            }
            button:disabled {
                background: #ccc;
                cursor: not-allowed;
            }
            #result {
                margin-top: 40px;
                font-size: 36px;
                font-weight: bold;
                text-align: center;
            }
            #loading {
                margin-top: 20px;
                color: grey;
            }
        </style>
    </head>
    <body>
        <h1 style="text-align: center">Análise de Comentários de Pacientes</h1>

        <p>Insira o comentário do paciente:</p>
        <textarea
            id="inputText"
            placeholder='Ex: "Excelente atendimento"'
        ></textarea>

        <button id="analyzeBtn" disabled>Analisar</button>

        <div id="loading"></div>
        <div id="result"></div>

        <script>
            let useModel = null;
            let headModel = null;

            // Загрузка моделей
            async function loadModels() {
                document.getElementById("loading").innerText =
                    "Carregando modelos... (20–60 seg na primeira vez)";

                try {
                    // USE модель
                    useModel = await use.load();

                    // Твоя head-модель
                    headModel = await tf.loadGraphModel("web_model/model.json");

                    document.getElementById("loading").innerText =
                        "Modelos carregados!";
                    document.getElementById("analyzeBtn").disabled = false;
                } catch (e) {
                    document.getElementById("loading").innerText = "";
                    document.getElementById("result").innerText =
                        "Erro ao carregar modelos";
                    document.getElementById("result").style.color = "red";
                    console.error(e);
                }
            }

            // Анализ текста
            async function analyze() {
                const text = document.getElementById("inputText").value.trim();
                if (!text) return;

                document.getElementById("analyzeBtn").disabled = true;
                document.getElementById("result").innerText = "";
                document.getElementById("loading").innerText = "Analisando...";

                try {
                    // Embedding от USE
                    const embeddings = await useModel.embed([text]);

                    // Предсказание твоей модели
                    const prediction = headModel.predict(embeddings);
                    const scores = await prediction.data();

                    // Освобождаем память
                    embeddings.dispose();
                    prediction.dispose();

                    // Находим максимум
                    let maxScore = -Infinity;
                    let label = -1;
                    for (let i = 0; i < scores.length; i++) {
                        if (scores[i] > maxScore) {
                            maxScore = scores[i];
                            label = i;
                        }
                    }

                    let resultText = "";
                    let resultColor = "grey";

                    if (label === 0) {
                        resultText = "Negativo";
                        resultColor = "red";
                    } else if (label === 1) {
                        resultText = "Neutro";
                        resultColor = "orange";
                    } else if (label === 2) {
                        resultText = "Positivo";
                        resultColor = "green";
                    } else {
                        resultText = "Resultado desconhecido";
                    }

                    document.getElementById("result").innerText = resultText;
                    document.getElementById("result").style.color = resultColor;
                } catch (e) {
                    document.getElementById("result").innerText =
                        "Erro na análise";
                    document.getElementById("result").style.color = "red";
                    console.error(e);
                }

                document.getElementById("loading").innerText = "";
                document.getElementById("analyzeBtn").disabled = false;
            }

            // Запуск загрузки моделей при открытии страницы
            loadModels();

            // Кнопка
            document
                .getElementById("analyzeBtn")
                .addEventListener("click", analyze);
        </script>
    </body>
</html>
